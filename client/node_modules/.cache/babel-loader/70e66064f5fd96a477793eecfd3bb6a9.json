{"ast":null,"code":"'use strict';\n\nconst Aspect = require('./operation').Aspect;\n\nconst CommandOperation = require('./command');\n\nconst defineAspects = require('./operation').defineAspects;\n\nconst crypto = require('crypto');\n\nconst handleCallback = require('../utils').handleCallback;\n\nconst toError = require('../utils').toError;\n\nconst emitWarning = require('../utils').emitWarning;\n\nclass AddUserOperation extends CommandOperation {\n  constructor(db, username, password, options) {\n    super(db, options);\n    this.username = username;\n    this.password = password;\n  }\n\n  _buildCommand() {\n    const db = this.db;\n    const username = this.username;\n    const password = this.password;\n    const options = this.options; // Get additional values\n\n    let roles = [];\n    if (Array.isArray(options.roles)) roles = options.roles;\n    if (typeof options.roles === 'string') roles = [options.roles]; // If not roles defined print deprecated message\n    // TODO: handle deprecation properly\n\n    if (roles.length === 0) {\n      emitWarning('Creating a user without roles is deprecated in MongoDB >= 2.6');\n    } // Check the db name and add roles if needed\n\n\n    if ((db.databaseName.toLowerCase() === 'admin' || options.dbName === 'admin') && !Array.isArray(options.roles)) {\n      roles = ['root'];\n    } else if (!Array.isArray(options.roles)) {\n      roles = ['dbOwner'];\n    }\n\n    const digestPassword = db.s.topology.lastIsMaster().maxWireVersion >= 7;\n    let userPassword = password;\n\n    if (!digestPassword) {\n      // Use node md5 generator\n      const md5 = crypto.createHash('md5'); // Generate keys used for authentication\n\n      md5.update(username + ':mongo:' + password);\n      userPassword = md5.digest('hex');\n    } // Build the command to execute\n\n\n    const command = {\n      createUser: username,\n      customData: options.customData || {},\n      roles: roles,\n      digestPassword\n    }; // No password\n\n    if (typeof password === 'string') {\n      command.pwd = userPassword;\n    }\n\n    return command;\n  }\n\n  execute(callback) {\n    const options = this.options; // Error out if digestPassword set\n\n    if (options.digestPassword != null) {\n      return callback(toError(\"The digestPassword option is not supported via add_user. Please use db.command('createUser', ...) instead for this option.\"));\n    } // Attempt to execute auth command\n\n\n    super.execute((err, r) => {\n      if (!err) {\n        return handleCallback(callback, err, r);\n      }\n\n      return handleCallback(callback, err, null);\n    });\n  }\n\n}\n\ndefineAspects(AddUserOperation, Aspect.WRITE_OPERATION);\nmodule.exports = AddUserOperation;","map":{"version":3,"sources":["C:/Users/Tanja Aakerholt/Documents/GitHub/portfolio2/client/node_modules/mongodb/lib/operations/add_user.js"],"names":["Aspect","require","CommandOperation","defineAspects","crypto","handleCallback","toError","emitWarning","AddUserOperation","constructor","db","username","password","options","_buildCommand","roles","Array","isArray","length","databaseName","toLowerCase","dbName","digestPassword","s","topology","lastIsMaster","maxWireVersion","userPassword","md5","createHash","update","digest","command","createUser","customData","pwd","execute","callback","err","r","WRITE_OPERATION","module","exports"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nconst Aspect = require('./operation').Aspect;\r\nconst CommandOperation = require('./command');\r\nconst defineAspects = require('./operation').defineAspects;\r\nconst crypto = require('crypto');\r\nconst handleCallback = require('../utils').handleCallback;\r\nconst toError = require('../utils').toError;\r\nconst emitWarning = require('../utils').emitWarning;\r\n\r\nclass AddUserOperation extends CommandOperation {\r\n  constructor(db, username, password, options) {\r\n    super(db, options);\r\n\r\n    this.username = username;\r\n    this.password = password;\r\n  }\r\n\r\n  _buildCommand() {\r\n    const db = this.db;\r\n    const username = this.username;\r\n    const password = this.password;\r\n    const options = this.options;\r\n\r\n    // Get additional values\r\n    let roles = [];\r\n    if (Array.isArray(options.roles)) roles = options.roles;\r\n    if (typeof options.roles === 'string') roles = [options.roles];\r\n\r\n    // If not roles defined print deprecated message\r\n    // TODO: handle deprecation properly\r\n    if (roles.length === 0) {\r\n      emitWarning('Creating a user without roles is deprecated in MongoDB >= 2.6');\r\n    }\r\n\r\n    // Check the db name and add roles if needed\r\n    if (\r\n      (db.databaseName.toLowerCase() === 'admin' || options.dbName === 'admin') &&\r\n      !Array.isArray(options.roles)\r\n    ) {\r\n      roles = ['root'];\r\n    } else if (!Array.isArray(options.roles)) {\r\n      roles = ['dbOwner'];\r\n    }\r\n\r\n    const digestPassword = db.s.topology.lastIsMaster().maxWireVersion >= 7;\r\n\r\n    let userPassword = password;\r\n\r\n    if (!digestPassword) {\r\n      // Use node md5 generator\r\n      const md5 = crypto.createHash('md5');\r\n      // Generate keys used for authentication\r\n      md5.update(username + ':mongo:' + password);\r\n      userPassword = md5.digest('hex');\r\n    }\r\n\r\n    // Build the command to execute\r\n    const command = {\r\n      createUser: username,\r\n      customData: options.customData || {},\r\n      roles: roles,\r\n      digestPassword\r\n    };\r\n\r\n    // No password\r\n    if (typeof password === 'string') {\r\n      command.pwd = userPassword;\r\n    }\r\n\r\n    return command;\r\n  }\r\n\r\n  execute(callback) {\r\n    const options = this.options;\r\n\r\n    // Error out if digestPassword set\r\n    if (options.digestPassword != null) {\r\n      return callback(\r\n        toError(\r\n          \"The digestPassword option is not supported via add_user. Please use db.command('createUser', ...) instead for this option.\"\r\n        )\r\n      );\r\n    }\r\n\r\n    // Attempt to execute auth command\r\n    super.execute((err, r) => {\r\n      if (!err) {\r\n        return handleCallback(callback, err, r);\r\n      }\r\n\r\n      return handleCallback(callback, err, null);\r\n    });\r\n  }\r\n}\r\n\r\ndefineAspects(AddUserOperation, Aspect.WRITE_OPERATION);\r\n\r\nmodule.exports = AddUserOperation;\r\n"]},"metadata":{},"sourceType":"script"}